{% extends "base.html" %}
{%load static%}
{%block content%}
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->


<!--Coded With Love By Mutiullah Samim-->

<body>
    <div class="container-fluid h-100">
        <div class="row justify-content-center h-100">
            <div class="col-md-8 col-xl-12 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="img_cont">
                                <img src="https://clipartart.com/images/admin-icon-clipart-5.jpg"
                                    class="rounded-circle user_img">
                                <span class="online_icon"></span>
                            </div>
                            <div class="user_info">
                                <span>Chat with Admin</span>
                                <!-- <p>1767 Messages</p> -->
                            </div>

                        </div>

                    </div>
                    <div class="card-body msg_card_body " id="dedd">
                        {% if exist_mess %}
                        {% for mes in chat %}
                        {% if mes.admin %}
                        <div class="d-flex justify-content-start mb-4">
                            <div class="img_cont_msg">
                                <img src="https://clipartart.com/images/admin-icon-clipart-5.jpg"
                                    class="rounded-circle user_img_msg">
                            </div>
                            <div class="msg_cotainer">
                                {{ mes.message}} <br>
                                <span class="msg_time_send">{{mes.pub_date}}</span>
                            </div>
                        </div>

                        {% else %}
                        <div class="d-flex justify-content-end mb-4">
                            <div class="msg_cotainer_send">
                                {{ mes.message}}
                                <br>
                                <span class="msg_time_send"> {{mes.pub_date}}</span>
                            </div>
                            <div class="img_cont_msg">
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTuK63MKLKu2yTG4Wg5TmcLV1n2gfzgQ3b30nrNtji7vfw31W5g"
                                    class="rounded-circle user_img_msg">
                            </div>
                        </div>
                        {% endif %}
                        {%endfor%}
                        {% endif %}

                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <!-- <div class="input-group-append">
                                <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                            </div> -->
                            <textarea name="" id="textsend" class="form-control type_msg"
                                placeholder="Type your message..."></textarea>
                            <div class="input-group-append">
                                <span class="input-group-text  send_btn" id="Sbtn"><img
                                        src="https://s3.us-east-2.amazonaws.com/upload-icon/uploads/icons/png/18556509761553771441-256.png"
                                        alt="" class="sendbtn"></i></span>
                            </div>
                        </div>
                    </div>
                    <audio id="music_id" src="/media/sms-alert-1-daniel_simon.mp3" preload="auto" ></audio>
                </div>
            </div>
        </div>
    </div>
</body>
<script>

    var roomName = "{{ room_name|escapejs }}";
    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat_view/' + roomName + '/');
    const messages = document.getElementById('dedd');
    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var data = data['message'];
        document.getElementById('music_id').play()
        if (data['admin']) {
            $('#dedd').append(
                '<div class="d-flex justify-content-start mb-4"><div class="img_cont_msg">'
                + '<img src="https://clipartart.com/images/admin-icon-clipart-5.jpg"'
                + 'class="rounded-circle user_img_msg"></div><div class="msg_cotainer">'
                + data.message + '<br><span class="msg_time_send">'
                + data.pub_date + '</span></div></div >'
            );
        } else {
            $('#dedd').append(
                '<div class="d-flex justify-content-end mb-4"><div class="msg_cotainer_send">'
                + data.message + '<br><span class="msg_time_send">'
                + data.pub_date + '</span></div><div class="img_cont_msg">'
                + '<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTuK63MKLKu2yTG4Wg5TmcLV1n2gfzgQ3b30nrNtji7vfw31W5g"'
                + 'class="rounded-circle user_img_msg"></div></div>'
            );
        }

        shouldScroll = messages.scrollTop + messages.clientHeight === messages.scrollHeight;
        /*
         * Get your messages, we'll just simulate it by appending a new one syncronously.
         */
        // After getting your messages.
        if (!shouldScroll) {
            scrollToBottom(messages);
        }
    }

    function scrollToBottom(messages) {
        messages.scrollTop = messages.scrollHeight;
    }
    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };
    chatSocket.onopen = function () {
        shouldScroll = messages.scrollTop + messages.clientHeight === messages.scrollHeight;
        /*
         * Get your messages, we'll just simulate it by appending a new one syncronously.
         */
        // After getting your messages.
        if (!shouldScroll) {
            scrollToBottom(messages);
        }
    };

    document.querySelector('#textsend').focus();
    document.querySelector('#textsend').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#Sbtn').click();
        }
    };

    document.querySelector('#Sbtn').onclick = function (e) {
        var messageInputDom = document.querySelector('#textsend');
        var message = messageInputDom.value;

        // var requestmessage = "{{ request }}";
        chatSocket.send(JSON.stringify({
            'message': message,
            'command': 'new_message',
            'chat_id': roomName
            // 'request': requestmessage,
        }));

        messageInputDom.value = '';
    };


</script>

<style>
    body,
    html {
        height: 100%;
        margin: 0;
        background: #7F7FD5;
        background: -webkit-linear-gradient(to right, #91EAE4, #86A8E7, #7F7FD5);
        background: linear-gradient(to right, #91EAE4, #86A8E7, #7F7FD5);
    }

    .chat {
        margin-top: auto;
        margin-bottom: auto;
    }

    .card {
        height: 500px;
        border-radius: 15px !important;
        background-color: rgba(0, 0, 0, 0.4) !important;
    }

    .contacts_body {
        padding: 0.75rem 0 !important;
        overflow-y: auto;
        white-space: nowrap;
    }

    .msg_card_body {
        overflow-y: auto;
    }

    .card-header {
        border-radius: 15px 15px 0 0 !important;
        border-bottom: 0 !important;
    }

    .card-footer {
        border-radius: 0 0 15px 15px !important;
        border-top: 0 !important;
    }

    .container {
        align-content: center;
    }

    .search {
        border-radius: 15px 0 0 15px !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 0 !important;
        color: white !important;
    }

    .search:focus {
        box-shadow: none !important;
        outline: 0px !important;
    }

    .type_msg {
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 0 !important;
        color: white !important;
        height: 60px !important;
        overflow-y: auto;
    }

    .type_msg:focus {
        box-shadow: none !important;
        outline: 0px !important;
    }

    .attach_btn {
        border-radius: 15px 0 0 15px !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 0 !important;
        color: white !important;
        cursor: pointer;
    }

    .send_btn {
        border-radius: 0 15px 15px 0 !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 0 !important;
        color: white !important;
        cursor: pointer;
    }

    .search_btn {
        border-radius: 0 15px 15px 0 !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 0 !important;
        color: white !important;
        cursor: pointer;
    }

    .contacts {
        list-style: none;
        padding: 0;
    }

    .contacts li {
        width: 100% !important;
        padding: 5px 10px;
        margin-bottom: 15px !important;
    }

    .active {
        background-color: rgba(0, 0, 0, 0.3);
    }

    .user_img {
        height: 70px;
        width: 70px;
        border: 1.5px solid #f5f6fa;

    }

    .user_img_msg {
        height: 40px;
        width: 40px;
        border: 1.5px solid #f5f6fa;

    }

    .img_cont {
        position: relative;
        height: 70px;
        width: 70px;
    }

    .img_cont_msg {
        height: 40px;
        width: 40px;
    }

    .online_icon {
        position: absolute;
        height: 15px;
        width: 15px;
        background-color: #4cd137;
        border-radius: 50%;
        bottom: 0.2em;
        right: 0.4em;
        border: 1.5px solid white;
    }

    .offline {
        background-color: #c23616 !important;
    }

    .user_info {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: 15px;
    }

    .user_info span {
        font-size: 20px;
        color: white;
    }

    .user_info p {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
    }

    .video_cam {
        margin-left: 50px;
        margin-top: 5px;
    }

    .video_cam span {
        color: white;
        font-size: 20px;
        cursor: pointer;
        margin-right: 20px;
    }

    .msg_cotainer {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: 10px;
        border-radius: 25px;
        background-color: #82ccdd;
        padding: 10px;
        position: relative;
    }

    .msg_cotainer_send {
        margin-top: auto;
        margin-bottom: auto;
        margin-right: 10px;
        border-radius: 25px;
        background-color: #78e08f;
        padding: 10px;
        position: relative;
    }

    .msg_time {
        position: absolute;
        left: 0;
        bottom: -15px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 10px;
    }

    .msg_time_send {
        /* position: absolute; */
        right: 0;
        bottom: -15px;
        color: rgba(27, 75, 231, 0.966);
        font-size: 10px;
    }

    .msg_head {
        position: relative;
    }

    #action_menu_btn {
        position: absolute;
        right: 10px;
        top: 10px;
        color: white;
        cursor: pointer;
        font-size: 20px;
    }

    .action_menu {
        z-index: 1;
        position: absolute;
        padding: 15px 0;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 15px;
        top: 30px;
        right: 15px;
        display: none;
    }

    .action_menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .action_menu ul li {
        width: 100%;
        padding: 10px 15px;
        margin-bottom: 5px;
    }

    .action_menu ul li i {
        padding-right: 10px;

    }

    .action_menu ul li:hover {
        cursor: pointer;
        background-color: rgba(0, 0, 0, 0.2);
    }

    @media(max-width: 576px) {
        .contacts_card {
            margin-bottom: 15px !important;
        }
    }

    .sendbtn {
        width: 25px;
        height: auto;
        position: relative;
    }
</style>

{%endblock content%}